<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Learning Go by Instrumenting a Go Application for Prometheus Metrics | Tanmay Bhat</title>
<meta name=keywords content="Go,Prometheus,Datadog"><meta name=description content="A Beginner&rsquo;s Perspective
Before we dive into the details, I recently started learning Go. This article is just a beginner&rsquo;s perspective on combining Go learning and building a simple Prometheus metrics exporter.
I had a requirement to build this exporter because, at my workplace, we use Datadog&rsquo;s SLO product alongside RUM monitoring. However, since all our other analytics and metrics are in Prometheus, I built this to consolidate all SLOs in one place."><meta name=author content="Tanmay Bhat"><link rel=canonical href=https://tanmay-bhat.github.io/posts/learning-go-by-instrumenting-a-go-application-for-prometheus-metrics/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://tanmay-bhat.github.io/memoji.png><link rel=icon type=image/png sizes=16x16 href=https://tanmay-bhat.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tanmay-bhat.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://tanmay-bhat.github.io/apple-touch-icon.png><link rel=mask-icon href=https://tanmay-bhat.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tanmay-bhat.github.io/posts/learning-go-by-instrumenting-a-go-application-for-prometheus-metrics/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-6PXF78BGMY"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-6PXF78BGMY")}</script><meta property="og:title" content="Learning Go by Instrumenting a Go Application for Prometheus Metrics"><meta property="og:description" content="A Beginner&rsquo;s Perspective
Before we dive into the details, I recently started learning Go. This article is just a beginner&rsquo;s perspective on combining Go learning and building a simple Prometheus metrics exporter.
I had a requirement to build this exporter because, at my workplace, we use Datadog&rsquo;s SLO product alongside RUM monitoring. However, since all our other analytics and metrics are in Prometheus, I built this to consolidate all SLOs in one place."><meta property="og:type" content="article"><meta property="og:url" content="https://tanmay-bhat.github.io/posts/learning-go-by-instrumenting-a-go-application-for-prometheus-metrics/"><meta property="og:image" content="https://tanmay-bhat.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-18T00:00:00+00:00"><meta property="og:site_name" content="Tanmay Bhat"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tanmay-bhat.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Learning Go by Instrumenting a Go Application for Prometheus Metrics"><meta name=twitter:description content="A Beginner&rsquo;s Perspective
Before we dive into the details, I recently started learning Go. This article is just a beginner&rsquo;s perspective on combining Go learning and building a simple Prometheus metrics exporter.
I had a requirement to build this exporter because, at my workplace, we use Datadog&rsquo;s SLO product alongside RUM monitoring. However, since all our other analytics and metrics are in Prometheus, I built this to consolidate all SLOs in one place."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tanmay-bhat.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Learning Go by Instrumenting a Go Application for Prometheus Metrics","item":"https://tanmay-bhat.github.io/posts/learning-go-by-instrumenting-a-go-application-for-prometheus-metrics/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Learning Go by Instrumenting a Go Application for Prometheus Metrics","name":"Learning Go by Instrumenting a Go Application for Prometheus Metrics","description":"A Beginner\u0026rsquo;s Perspective Before we dive into the details, I recently started learning Go. This article is just a beginner\u0026rsquo;s perspective on combining Go learning and building a simple Prometheus metrics exporter.\nI had a requirement to build this exporter because, at my workplace, we use Datadog\u0026rsquo;s SLO product alongside RUM monitoring. However, since all our other analytics and metrics are in Prometheus, I built this to consolidate all SLOs in one place.\n","keywords":["Go","Prometheus","Datadog"],"articleBody":"A Beginner’s Perspective Before we dive into the details, I recently started learning Go. This article is just a beginner’s perspective on combining Go learning and building a simple Prometheus metrics exporter.\nI had a requirement to build this exporter because, at my workplace, we use Datadog’s SLO product alongside RUM monitoring. However, since all our other analytics and metrics are in Prometheus, I built this to consolidate all SLOs in one place.\nDatadog API Response Example For an example request curl -X GET \"https://api.datadoghq.com/api/v1/slo/${slo_id}/history\", the response is as follows:\n{ \"data\": { \"overall\": { \"name\": \"Example SLO\", \"sli_value\": 0.99 ... }, \"slo\": { \"target_threshold\": 0.95, \"timeframe\": \"7d\" ... }, ... } } Exporter Requirements For simplicity, let’s focus on creating a Prometheus exporter that:\nParses the Datadog API response Creates Prometheus metrics for the following example data: datadog_slo_uptime{rolling_timeframe=\"\u003c\u003e\" slo_name=\"\u003c\u003e\" threshold=\"\u003c\u003e\" window=\"\u003c\u003e\"} datadog_api_error_total{api_call=\"\u003c\u003e\",status_code=\"\u003c\u003e\"} Importing Required Client Packages As we need clients of Datadog and Prometheus, let’s import both:\nimport ( \"github.com/Datadog/datadog-api-client-go/v2/api/datadog\" \"github.com/Datadog/datadog-api-client-go/v2/api/datadogV1\" \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/push\" ) Constructing Structs to Match API Response As the data we need is inside the data field, in the API response, let’s create a struct to parse them later on.\nA struct in Go is a container to group similar or related data together, somewhat similar to classes in other object-oriented languages.\nLet’s create a struct called Response which will contain Data of type Data struct and to match the overall structure of the API response :\ntype Response struct { Data Data `json:\"data\"` } We specified json:\"data\" because that’s the way of mapping the actual JSON response’s data field to this object.\nAs overall and slo are nested fields of data, let’s create a struct called Data and add these two inside that:\ntype Data struct { Overall Overall `json:\"overall\"` Slo Slo `json:\"slo\"` } Now, let’s create structs called Overall and Slo which will contain the actual data we need:\ntype Overall struct { Name string `json:\"name\"` SLI float64 `json:\"sli_value\"` } type Slo struct { Threshold float64 `json:\"target_threshold\"` Timeframe string `json:\"timeframe\"` } Global Variables and Metric Declarations We declare the following variables:\nvar ( API_KEY = os.Getenv(\"DD_API_KEY\") APP_KEY = os.Getenv(\"DD_APP_KEY\") SLO_ID = os.Getenv(\"DD_SLO_ID\") PROM_ENDPOINT = os.Getenv(\"PROMETHEUS_ENDPOINT\") ctx context.Context api *datadogV1.ServiceLevelObjectivesApi apiClient *datadog.APIClient // Declare Prometheus metrics for monitoring Datadog SLO DataDogSLOGauge = prometheus.NewGaugeVec(prometheus.GaugeOpts{ Namespace: \"datadog\", Name: \"slo_uptime\", Help: \"History details of a Datadog SLO\"}, []string{\"slo_name\", \"threshold\", \"window\", \"rolling_timeframe\"}, ) // Declare Prometheus metrics for monitoring Datadog API Errors DataDogAPIErrorCounter = prometheus.NewCounterVec(prometheus.CounterOpts{ Namespace: \"datadog\", Name: \"api_error_total\", Help: \"Total Error count on requests to Datadog API\"}, []string{\"api_call\", \"status_code\"}, ) logger *log.Logger ) Implementing the Exporter Now that we have our structs defined to match the Datadog API response, let’s implement the core functionality of our exporter.\nInitializing the Datadog Client\nFirst, we initialize the Datadog client. We’ll create a function called InitDataDogClient():\nfunc InitDataDogClient() error { ctx = context.WithValue(context.Background(), datadog.ContextAPIKeys, map[string]datadog.APIKey{ \"apiKeyAuth\": {Key: API_KEY}, \"appKeyAuth\": {Key: APP_KEY}, }, ) configuration := datadog.NewConfiguration() configuration.RetryConfiguration.EnableRetry = true // defaults to 3 retries apiClient = datadog.NewAPIClient(configuration) api = datadogV1.NewServiceLevelObjectivesApi(apiClient) return nil } Context in Go is a way to manage timeouts, cancellation, and passing data like API keys across multiple functions or API boundaries. In the above example, context is used to pass the Datadog API credentials along with API requests.\nThe above function also checks if the necessary environment variables are set, creates a context with the API keys, and initializes the Datadog client and then create an instance of NewServiceLevelObjectivesApi API and set it to api variable.\nFetching SLO Data\nNext, let’s implement the GetSloData function to fetch SLO data from Datadog:\nfunc GetSloData(sloDataID string, daysWindow int) (sliValue float64, sloName string, threshold float64, rollingTimeframe string, error error) { if sloDataID == \"\" { logger.Fatal(\"sloDataID environment variable is not set\") } fromTime := time.Now().AddDate(0, 0, -daysWindow).Unix() toTime := time.Now().Unix() resp, r, err := api.GetSLOHistory(ctx, sloDataID, fromTime, toTime) if err != nil { statusCode := 0 if r != nil { statusCode = r.StatusCode } DataDogAPIErrorCounter.WithLabelValues(\"GetSLOHistory\", strconv.Itoa(statusCode)).Inc() return 0, \"\", 0, \"\", fmt.Errorf(\"error when calling `ServiceLevelObjectivesApi.GetSLOHistory`: %v\", err) } responseContent, err := json.Marshal(resp) if err != nil { return 0, \"\", 0, \"\", fmt.Errorf(\"error marshaling response: %v\", err) } var response Response err = json.Unmarshal(responseContent, \u0026response) if err != nil { logger.Printf(\"Error unmarshaling JSON: %s\\n\", err) return } sli = response.Data.Overall.SLI slo = response.Data.Overall.Name threshold = response.Data.Slo.Threshold rollingTimeframe = response.Data.Slo.Timeframe return sli, slo, threshold, rollingTimeframe, nil } This function takes the SLO ID and the number of days to look back as parameters. It then makes a request to the Datadog API, parses the response, and returns the relevant SLO data.\nAPI Request api.GetSLOHistor is called with the provided SLO ID and time window. Returns three values: resp (SLOHistoryResponse struct): Contains the API response data. r (_nethttp.Response): The actual HTTP response. err (error): Any error that occurred during the request. Error Handling \u0026 Metric Update If an error occurs, update the DataDogAPIErrorCounter metric: Set the api_call label to \"GetSLOHistory\". Convert the HTTP status code (r.StatusCode) to a string using strconv.Itoa() and set it as the status_code label. This is needed as labels can only be of type string in Prometheus. Increment the metric value using Inc(). Response Parsing As we know that resp is of type SLOHistoryResponse which is a struct, convert it into a JSON using json.Marshal(resp) and store the result in responseContent. Declare a Response struct variable, response. Unmarshal the JSON data into the response struct using json.Unmarshal(responseContent, \u0026response). It takes JSON data and a pointer as arguments. In our case, we passed a pointer to the response variable (\u0026response). Extract Relevant SLO Data Access the parsed data using the response struct, e.g., sliValue = response.Data.Overall.SLI Note: Prometheus labels are always sorted alphabetically.\nMain Function\nNow, let’s implement our main() function to tie everything together:\nfunc main() { logger = log.New(os.Stdout, \"\", log.Ldate|log.Ltime|log.Lshortfile) err := InitDataDogClient() if err != nil { logger.Printf(\"Failed to initialize Datadog client: %v\\n\", err) return } logger.Printf(\"Datadog client initialized successfully\\n\") // Use a custom registry for consistency and to drop default go_.* metrics registry := prometheus.NewRegistry() registry.MustRegister(DataDogSLOGauge, DataDogAPIErrorCounter) days := []int{7, 30, 90} // Fetch SLO data for different time windows for _, day := range days { logger.Printf(\"Fetching SLO history for %d days\\n\", day) sliValue, sloName, threshold, rollingTimeframe, err := GetSloData(SLO_ID, day) if err != nil { logger.Printf(\"Error getting SLO data: %v\\n\", err) } else { g := DataDogSLOGauge.WithLabelValues( sloName, fmt.Sprintf(\"%.2f\", threshold), fmt.Sprintf(\"%dd\", day), rollingTimeframe, ) g.Set(sliValue) } } // Collect all the metrics and push to Prometheus endpoint pusher := push.New(PROM_ENDPOINT, \"datadog-slo-exporter\").Gatherer(registry) if err := pusher.Push(); err != nil { logger.Printf(\"Error pushing metrics to VictoriaMetrics: %v\\n\", err) } else { logger.Printf(\"Metrics pushed to VictoriaMetrics successfully\\n\") } } I set the model to push instead of Prometheus’s default pull since we don’t need to run this as a service. The best way to run this is as a cronjob.\nKey Concepts in Prometheus Client Library Collector : A collector is a part of an exporter that represents a set of metrics. It may be a single metric if it is part of direct instrumentation, or many metrics if it is pulling metrics from another system. In our case, we used two collector types, Guage and Counter. Registry : A registry is a central place to store and manage multiple collectors. It keeps track of all registered metrics and their values. Prometheus client by default has a registry which collects go related metrics, for our simple use case, it’s overkill, hence we create a new registry and register our metrics to that. registry := prometheus.NewRegistry() registry.MustRegister(DataDogSLOGauge, DataDogAPIErrorCounter) Gatherer : A gatherer is an interface responsible for collecting metrics from registered collectors. It gathers metrics from all collectors in a registry and prepares them for scraping by Prometheus. As we use a custom registry called registry, while pushing the metric, we specify that. push.New(PROM_ENDPOINT, \"datadog-slo-exporter\").Gatherer(registry) Using Prometheus Pull (Alternative to Push) import ( \"net/http\" \"github.com/prometheus/client_golang/prometheus/promhttp\" ) func main() { http.Handle(\"/metrics\", promhttp.Handler(registry)) http.ListenAndServe(\":2112\", nil) } References https://docs.datadoghq.com/api/latest/service-level-objectives/#get-an-slos-history https://github.com/prometheus/client_golang https://github.com/Datadog/datadog-api-client-go https://prometheus.io/docs/practices/instrumentation/ Complete code can be found here : https://github.com/tanmay-bhat/datadog-slo-exporter\n","wordCount":"1332","inLanguage":"en","image":"https://tanmay-bhat.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-18T00:00:00Z","dateModified":"2024-10-18T00:00:00Z","author":{"@type":"Person","name":"Tanmay Bhat"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tanmay-bhat.github.io/posts/learning-go-by-instrumenting-a-go-application-for-prometheus-metrics/"},"publisher":{"@type":"Organization","name":"Tanmay Bhat","logo":{"@type":"ImageObject","url":"https://tanmay-bhat.github.io/memoji.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tanmay-bhat.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://tanmay-bhat.github.io/about/ title=About><span>About</span></a></li><li><a href=https://tanmay-bhat.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://tanmay-bhat.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tanmay-bhat.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://tanmay-bhat.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Learning Go by Instrumenting a Go Application for Prometheus Metrics</h1><div class=post-meta><span title='2024-10-18 00:00:00 +0000 UTC'>October 18, 2024</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Tanmay Bhat&nbsp;|&nbsp;<a href=https://github.com/tanmay-bhat/tanmay-bhat.github.io/blob/main/content/posts/Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h3 id=a-beginners-perspective>A Beginner&rsquo;s Perspective<a hidden class=anchor aria-hidden=true href=#a-beginners-perspective>#</a></h3><p>Before we dive into the details, I recently started learning Go. This article is just a beginner&rsquo;s perspective on combining Go learning and building a simple Prometheus metrics exporter.</p><p>I had a requirement to build this exporter because, at my workplace, we use <a href=https://www.datadoghq.com/product/service-level-objectives/>Datadog&rsquo;s SLO</a> product alongside RUM monitoring. However, since all our other analytics and metrics are in Prometheus, I built this to consolidate all SLOs in one place.</p><h3 id=datadog-api-response-example>Datadog API Response Example<a hidden class=anchor aria-hidden=true href=#datadog-api-response-example>#</a></h3><p>For an example request <code>curl -X GET "https://api.datadoghq.com/api/v1/slo/${slo_id}/history"</code>, the response is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;overall&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Example SLO&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;sli_value&#34;</span>: <span style=color:#ae81ff>0.99</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;slo&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;target_threshold&#34;</span>: <span style=color:#ae81ff>0.95</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;timeframe&#34;</span>: <span style=color:#e6db74>&#34;7d&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=exporter-requirements>Exporter Requirements<a hidden class=anchor aria-hidden=true href=#exporter-requirements>#</a></h3><p>For simplicity, let&rsquo;s focus on creating a Prometheus exporter that:</p><ol><li>Parses the Datadog API response</li><li>Creates Prometheus metrics for the following example data:</li></ol><pre tabindex=0><code>datadog_slo_uptime{rolling_timeframe=&#34;&lt;&gt;&#34; slo_name=&#34;&lt;&gt;&#34; threshold=&#34;&lt;&gt;&#34; window=&#34;&lt;&gt;&#34;}

datadog_api_error_total{api_call=&#34;&lt;&gt;&#34;,status_code=&#34;&lt;&gt;&#34;}
</code></pre><h3 id=importing-required-client-packages>Importing Required Client Packages<a hidden class=anchor aria-hidden=true href=#importing-required-client-packages>#</a></h3><p>As we need clients of Datadog and Prometheus, let&rsquo;s import both:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/Datadog/datadog-api-client-go/v2/api/datadog&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/Datadog/datadog-api-client-go/v2/api/datadogV1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus/push&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=constructing-structs-to-match-api-response>Constructing Structs to Match API Response<a hidden class=anchor aria-hidden=true href=#constructing-structs-to-match-api-response>#</a></h3><p>As the data we need is inside the data field, in the API response, let&rsquo;s create a struct to parse them later on.</p><p>A struct in Go is a container to group similar or related data together, somewhat similar to classes in other object-oriented languages.</p><p>Let&rsquo;s create a struct called <code>Response</code> which will contain <code>Data</code> of type <code>Data</code> struct and to match the overall structure of the API response :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Response</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Data</span> <span style=color:#a6e22e>Data</span> <span style=color:#e6db74>`json:&#34;data&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We specified <code>json:"data"</code> because that&rsquo;s the way of <a href=https://pkg.go.dev/encoding/json>mapping</a> the actual JSON response&rsquo;s data field to this object.</p><p>As <code>overall</code> and <code>slo</code> are nested fields of <code>data</code>, let&rsquo;s create a struct called <code>Data</code> and add these two inside that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Data</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Overall</span> <span style=color:#a6e22e>Overall</span> <span style=color:#e6db74>`json:&#34;overall&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Slo</span>     <span style=color:#a6e22e>Slo</span>     <span style=color:#e6db74>`json:&#34;slo&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s create structs called <code>Overall</code> and <code>Slo</code> which will contain the actual data we need:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Overall</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>  <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SLI</span>  <span style=color:#66d9ef>float64</span> <span style=color:#e6db74>`json:&#34;sli_value&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Slo</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Threshold</span> <span style=color:#66d9ef>float64</span> <span style=color:#e6db74>`json:&#34;target_threshold&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeframe</span> <span style=color:#66d9ef>string</span>  <span style=color:#e6db74>`json:&#34;timeframe&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=global-variables-and-metric-declarations>Global Variables and Metric Declarations<a hidden class=anchor aria-hidden=true href=#global-variables-and-metric-declarations>#</a></h3><p>We declare the following variables:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>API_KEY</span>       = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DD_API_KEY&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>APP_KEY</span>       = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DD_APP_KEY&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SLO_ID</span>        = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DD_SLO_ID&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PROM_ENDPOINT</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PROMETHEUS_ENDPOINT&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>       <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>api</span>       <span style=color:#f92672>*</span><span style=color:#a6e22e>datadogV1</span>.<span style=color:#a6e22e>ServiceLevelObjectivesApi</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiClient</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>datadog</span>.<span style=color:#a6e22e>APIClient</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Declare Prometheus metrics for monitoring Datadog SLO
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>DataDogSLOGauge</span> = <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewGaugeVec</span>(<span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>GaugeOpts</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Namespace</span>: <span style=color:#e6db74>&#34;datadog&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;slo_uptime&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Help</span>:      <span style=color:#e6db74>&#34;History details of a Datadog SLO&#34;</span>},
</span></span><span style=display:flex><span>        []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;slo_name&#34;</span>, <span style=color:#e6db74>&#34;threshold&#34;</span>, <span style=color:#e6db74>&#34;window&#34;</span>, <span style=color:#e6db74>&#34;rolling_timeframe&#34;</span>},
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Declare Prometheus metrics for monitoring Datadog API Errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>DataDogAPIErrorCounter</span> = <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewCounterVec</span>(<span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>CounterOpts</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Namespace</span>: <span style=color:#e6db74>&#34;datadog&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;api_error_total&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Help</span>:      <span style=color:#e6db74>&#34;Total Error count on requests to Datadog API&#34;</span>},
</span></span><span style=display:flex><span>        []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;api_call&#34;</span>, <span style=color:#e6db74>&#34;status_code&#34;</span>},
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=implementing-the-exporter>Implementing the Exporter<a hidden class=anchor aria-hidden=true href=#implementing-the-exporter>#</a></h3><p>Now that we have our structs defined to match the Datadog API response, let&rsquo;s implement the core functionality of our exporter.</p><p><strong>Initializing the Datadog Client</strong></p><p>First, we initialize the Datadog client. We&rsquo;ll create a function called <code>InitDataDogClient()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitDataDogClient</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>datadog</span>.<span style=color:#a6e22e>ContextAPIKeys</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>datadog</span>.<span style=color:#a6e22e>APIKey</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;apiKeyAuth&#34;</span>: {<span style=color:#a6e22e>Key</span>: <span style=color:#a6e22e>API_KEY</span>},
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;appKeyAuth&#34;</span>: {<span style=color:#a6e22e>Key</span>: <span style=color:#a6e22e>APP_KEY</span>},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>configuration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>datadog</span>.<span style=color:#a6e22e>NewConfiguration</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>configuration</span>.<span style=color:#a6e22e>RetryConfiguration</span>.<span style=color:#a6e22e>EnableRetry</span> = <span style=color:#66d9ef>true</span> <span style=color:#75715e>// defaults to 3 retries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>apiClient</span> = <span style=color:#a6e22e>datadog</span>.<span style=color:#a6e22e>NewAPIClient</span>(<span style=color:#a6e22e>configuration</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>api</span> = <span style=color:#a6e22e>datadogV1</span>.<span style=color:#a6e22e>NewServiceLevelObjectivesApi</span>(<span style=color:#a6e22e>apiClient</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Context in Go is a way to manage timeouts, cancellation, and passing data like API keys across multiple functions or API boundaries.
In the above example, context is used to pass the Datadog API credentials along with API requests.</p><p>The above function also checks if the necessary environment variables are set, creates a context with the API keys, and initializes the Datadog client and then create an instance of <code>NewServiceLevelObjectivesApi</code> API and set it to <code>api</code> variable.</p><p><strong>Fetching SLO Data</strong></p><p>Next, let&rsquo;s implement the <code>GetSloData</code> function to fetch SLO data from Datadog:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetSloData</span>(<span style=color:#a6e22e>sloDataID</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>daysWindow</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>sliValue</span> <span style=color:#66d9ef>float64</span>, <span style=color:#a6e22e>sloName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>threshold</span> <span style=color:#66d9ef>float64</span>, <span style=color:#a6e22e>rollingTimeframe</span> <span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sloDataID</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#e6db74>&#34;sloDataID environment variable is not set&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fromTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>AddDate</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#a6e22e>daysWindow</span>).<span style=color:#a6e22e>Unix</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>toTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Unix</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>GetSLOHistory</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>sloDataID</span>, <span style=color:#a6e22e>fromTime</span>, <span style=color:#a6e22e>toTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>StatusCode</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>DataDogAPIErrorCounter</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#e6db74>&#34;GetSLOHistory&#34;</span>, <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>statusCode</span>)).<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error when calling `ServiceLevelObjectivesApi.GetSLOHistory`: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>responseContent</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>resp</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error marshaling response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>response</span> <span style=color:#a6e22e>Response</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>responseContent</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>response</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error unmarshaling JSON: %s\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sli</span> = <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Data</span>.<span style=color:#a6e22e>Overall</span>.<span style=color:#a6e22e>SLI</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>slo</span> = <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Data</span>.<span style=color:#a6e22e>Overall</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>threshold</span> = <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Data</span>.<span style=color:#a6e22e>Slo</span>.<span style=color:#a6e22e>Threshold</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rollingTimeframe</span> = <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Data</span>.<span style=color:#a6e22e>Slo</span>.<span style=color:#a6e22e>Timeframe</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sli</span>, <span style=color:#a6e22e>slo</span>, <span style=color:#a6e22e>threshold</span>, <span style=color:#a6e22e>rollingTimeframe</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This function takes the SLO ID and the number of days to look back as parameters. It then makes a request to the Datadog API, parses the response, and returns the relevant SLO data.</p><ol><li>API Request<ul><li><code>api.GetSLOHistor</code> is called with the provided SLO ID and time window.</li><li>Returns three values:<ul><li><code>resp</code> (SLOHistoryResponse struct): Contains the API response data.</li><li><code>r</code> (_nethttp.Response): The actual HTTP response.</li><li><code>err</code> (error): Any error that occurred during the request.</li></ul></li></ul></li><li>Error Handling & Metric Update
If an error occurs, update the <code>DataDogAPIErrorCounter</code> metric:<ul><li>Set the <code>api_call</code> label to <code>"GetSLOHistory"</code>.</li><li>Convert the HTTP status code (<code>r.StatusCode</code>) to a string using <code>strconv.Itoa()</code> and set it as the <code>status_code</code> label. This is needed as labels can only be of type <code>string</code> in Prometheus.</li><li>Increment the metric value using <code>Inc()</code>.</li></ul></li><li>Response Parsing<ul><li>As we know that <code>resp</code> is of type SLOHistoryResponse which is a struct, convert it into a JSON using <code>json.Marshal(resp)</code> and store the result in <code>responseContent</code>.</li><li>Declare a <code>Response</code> struct variable, <code>response</code>.</li><li>Unmarshal the JSON data into the response struct using <code>json.Unmarshal(responseContent, &amp;response)</code>.<ul><li>It takes JSON data and a pointer as arguments. In our case, we passed a pointer to the response variable <code>(&amp;response)</code>.</li></ul></li></ul></li><li>Extract Relevant SLO Data<ul><li>Access the parsed data using the response struct, e.g., <code>sliValue = response.Data.Overall.SLI</code></li></ul></li></ol><p>Note: Prometheus labels are always sorted alphabetically.</p><p><strong>Main Function</strong></p><p>Now, let&rsquo;s implement our <code>main()</code> function to tie everything together:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span> = <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Ldate</span>|<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Ltime</span>|<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Lshortfile</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InitDataDogClient</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to initialize Datadog client: %v\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Datadog client initialized successfully\n&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use a custom registry for consistency and to drop default go_.*  metrics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>registry</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewRegistry</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>MustRegister</span>(<span style=color:#a6e22e>DataDogSLOGauge</span>, <span style=color:#a6e22e>DataDogAPIErrorCounter</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>days</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>90</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Fetch SLO data for different time windows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>day</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>days</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Fetching SLO history for %d days\n&#34;</span>, <span style=color:#a6e22e>day</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sliValue</span>, <span style=color:#a6e22e>sloName</span>, <span style=color:#a6e22e>threshold</span>, <span style=color:#a6e22e>rollingTimeframe</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetSloData</span>(<span style=color:#a6e22e>SLO_ID</span>, <span style=color:#a6e22e>day</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error getting SLO data: %v\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DataDogSLOGauge</span>.<span style=color:#a6e22e>WithLabelValues</span>(
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>sloName</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%.2f&#34;</span>, <span style=color:#a6e22e>threshold</span>),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%dd&#34;</span>, <span style=color:#a6e22e>day</span>),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>rollingTimeframe</span>,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>sliValue</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Collect all the metrics and push to Prometheus endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pusher</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>PROM_ENDPOINT</span>, <span style=color:#e6db74>&#34;datadog-slo-exporter&#34;</span>).<span style=color:#a6e22e>Gatherer</span>(<span style=color:#a6e22e>registry</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pusher</span>.<span style=color:#a6e22e>Push</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error pushing metrics to VictoriaMetrics: %v\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Metrics pushed to VictoriaMetrics successfully\n&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I set the model to <code>push</code> instead of Prometheus&rsquo;s default <code>pull</code> since we don&rsquo;t need to run this as a service. The best way to run this is as a cronjob.</p><h3 id=key-concepts-in-prometheus-client-library>Key Concepts in Prometheus Client Library<a hidden class=anchor aria-hidden=true href=#key-concepts-in-prometheus-client-library>#</a></h3><ul><li>Collector :
A collector is a part of an exporter that represents a set of metrics. It may be a single metric if it is part of direct instrumentation, or many metrics if it is pulling metrics from another system.
In our case, we used two collector types, Guage and Counter.</li><li>Registry :
A registry is a central place to store and manage multiple collectors. It keeps track of all registered metrics and their values.
Prometheus client by default has a registry which collects go related metrics, for our simple use case, it&rsquo;s overkill, hence we create a new registry and register our metrics to that.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>registry</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>NewRegistry</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>MustRegister</span>(<span style=color:#a6e22e>DataDogSLOGauge</span>, <span style=color:#a6e22e>DataDogAPIErrorCounter</span>)
</span></span></code></pre></div><ul><li>Gatherer :
A gatherer is an interface responsible for collecting metrics from registered collectors. It gathers metrics from all collectors in a registry and prepares them for scraping by Prometheus.</li><li>As we use a custom registry called <code>registry</code>, while pushing the metric, we specify that.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>push</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>PROM_ENDPOINT</span>, <span style=color:#e6db74>&#34;datadog-slo-exporter&#34;</span>).<span style=color:#a6e22e>Gatherer</span>(<span style=color:#a6e22e>registry</span>)
</span></span></code></pre></div><h3 id=using-prometheus-pull-alternative-to-push>Using Prometheus Pull (Alternative to Push)<a hidden class=anchor aria-hidden=true href=#using-prometheus-pull-alternative-to-push>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/metrics&#34;</span>, <span style=color:#a6e22e>promhttp</span>.<span style=color:#a6e22e>Handler</span>(<span style=color:#a6e22e>registry</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:2112&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://docs.datadoghq.com/api/latest/service-level-objectives/#get-an-slos-history>https://docs.datadoghq.com/api/latest/service-level-objectives/#get-an-slos-history</a></li><li><a href=https://github.com/prometheus/client_golang>https://github.com/prometheus/client_golang</a></li><li><a href=https://github.com/Datadog/datadog-api-client-go>https://github.com/Datadog/datadog-api-client-go</a></li><li><a href=https://prometheus.io/docs/practices/instrumentation/>https://prometheus.io/docs/practices/instrumentation/</a></li></ul><p>Complete code can be found here : <a href=https://github.com/tanmay-bhat/datadog-slo-exporter>https://github.com/tanmay-bhat/datadog-slo-exporter</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tanmay-bhat.github.io/tags/go/>Go</a></li><li><a href=https://tanmay-bhat.github.io/tags/prometheus/>Prometheus</a></li><li><a href=https://tanmay-bhat.github.io/tags/datadog/>Datadog</a></li></ul><nav class=paginav><a class=next href=https://tanmay-bhat.github.io/posts/validate-argocd-with-opa/><span class=title>Next »</span><br><span>Validating ArgoCD Application Manifest With Open Policy Agent</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on x" href="https://x.com/intent/tweet/?text=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics&amp;url=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f&amp;hashtags=Go%2cPrometheus%2cDatadog"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f&amp;title=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics&amp;summary=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics&amp;source=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f&title=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on whatsapp" href="https://api.whatsapp.com/send?text=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics%20-%20https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on telegram" href="https://telegram.me/share/url?text=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics&amp;url=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Learning Go by Instrumenting a Go Application for Prometheus Metrics on ycombinator" href="https://news.ycombinator.com/submitlink?t=Learning%20Go%20by%20Instrumenting%20a%20Go%20Application%20for%20Prometheus%20Metrics&u=https%3a%2f%2ftanmay-bhat.github.io%2fposts%2flearning-go-by-instrumenting-a-go-application-for-prometheus-metrics%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tanmay-bhat.github.io/>Tanmay Bhat</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>